#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´ÐµÐ¿Ð»Ð¾Ñ Telegram Comment Bot
# Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð¾Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ bot

set -e

echo "ðŸ¤– ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Telegram Comment Bot..."

cd /home/bot/tg-comment-bot

# ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)
if [ ! -d ".git" ]; then
    echo "ðŸ“¥ ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ..."
    # Ð•ÑÐ»Ð¸ Ñƒ Ð²Ð°Ñ ÐµÑÑ‚ÑŒ Git Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹, Ñ€Ð°ÑÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÑƒÑŽ ÑÑ‚Ñ€Ð¾ÐºÑƒ:
    # git clone https://github.com/your-username/your-repo.git .
    echo "âš ï¸ ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¸Ð»Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ Git Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹"
fi

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°
if [ ! -f ".env" ]; then
    echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°..."
    cat > .env << EOF
# Telegram Bot Configuration
TELEGRAM_BOT_TOKEN=7044517029:AAGvO2gu8UeqQEU-BTDgU2GNjK2SvvEQNDc

# Qwen API Configuration
QWEN_API_URL=http://localhost:3264
QWEN_API_TIMEOUT=30000
QWEN_API_RETRY_ATTEMPTS=3

# Database Configuration
DATABASE_PATH=./bot/data/bot.db
LEARNING_ENABLED=true
FEEDBACK_STORAGE_PATH=./bot/data/learning
MIN_FEEDBACK_FOR_TRAINING=10
FEEDBACK_RETENTION_DAYS=90

# Chat Configuration
MAX_CHATS_PER_USER=10
MAX_CHAT_NAME_LENGTH=50
AUTO_CLEANUP_INTERVAL=86400000

# Logging
LOG_LEVEL=info
LOG_FILE=./logs/bot.log

# Environment
NODE_ENV=production
PORT=3000
EOF
    echo "âš ï¸ ÐÐµ Ð·Ð°Ð±ÑƒÐ´ÑŒÑ‚Ðµ Ð¾Ñ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ .env Ñ„Ð°Ð¹Ð» Ð¸ ÑƒÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð²Ð°Ñˆ TELEGRAM_BOT_TOKEN!"
fi

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹..."
mkdir -p bot/data
mkdir -p logs
mkdir -p bot/data/learning

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
npm install --production

# Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
echo "ðŸ—„ï¸ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
if [ -f "scripts/migrate-to-database.js" ]; then
    node scripts/migrate-to-database.js
fi

# Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°
echo "ðŸ¤– Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°..."
if [ -f "ecosystem.config.js" ]; then
    pm2 start ecosystem.config.js
else
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ ecosystem.config.js ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚
    cat > ecosystem.config.js << EOF
module.exports = {
  apps: [{
    name: 'tg-comment-bot',
    script: 'index.js',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production'
    }
  }]
};
EOF
    pm2 start ecosystem.config.js
fi

# Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ PM2
pm2 save

echo "âœ… Ð‘Ð¾Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ñ€Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚!"
echo "ðŸ“Š ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ: pm2 status"
echo "ðŸ“‹ ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð»Ð¾Ð³Ð¸: pm2 logs tg-comment-bot"
echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº: pm2 restart tg-comment-bot"
echo "â¹ï¸ ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°: pm2 stop tg-comment-bot"
